
# ClassMusEEG

**ClassMusEEG** - фреймворк, предназначенный для предварительной обработки данных ЭЭГ, записанных во время восприятия музыкальных стимулов, извлечения признаков и оптимизации моделей машинного обучения.

## Описание проекта

В рамках исследования решалась задача классификации музыкальных стимулов на основе анализа данных ЭЭГ. Использованные во время работы функции собраны во фреймворк. Обрабатывался набор данных [1]. 

Фреймворк включает в себя функции реализации трех подходов извлечения признаков: скользящего окна, выделения частотных и частотно-временных характеристик. Кроме того, инструмент позволяет производить оптимизацию гиперпараметров моделей LSTM, Bi-LSTM, SVM, SGD Classifier, а также загружать предобученные модели и делать предсказания на своих данных. У каждой функции есть документация, которую можно вызвать с помощью help(название_функции).

Данные ЭЭГ должны подаваться в формате CSV с названием Sub{n}_Stim{m}_Trial{k}, где n - номер испытуемого, m - номер стимула, k - номер пробы. Предсказания на готовой модели можно получить загрузив данные ЭЭГ с любым названием. Структура CSV: строки - временные отсчеты, а столбцы - каналы ЭЭГ.

Наиболее эффективный подход: использование окна с FFT с размером окна 3 секунды, с перекрытием в 1.5 секунды для извлечения признаков из	14 каналов (CP4, CP6, C6, TP8, T8, F8, FT8, CP3, CP5, C5, TP7, T7, F7, FT7) либо (с небольшим ухудшением результатов) 4 каналов (T8, FT8, T7, FT7), а затем их обработка с Bi-LSTM.

### Структура функций:
- **Загрузка и подготовка данных**:
  - `load_data`: Загрузка набора данных из CSV-файлов для указанных испытуемых, стимулов, проб и каналов.
  - `organize`: Загрузка данных для организации одной записи ЭЭГ заданного испытуемого, стимула и пробы.
  - `timeframe`: Выборка данных в пределах заданного временного интервала.
  - `average_trials_dynamic`: Усреднение данных между всеми сочетаниями проб и усреднение всех проб (+ 1 запись) для каждого субъекта и стимула, добавление усредненных записей для увеличения набора данных.
  - `bandpass_filter`: Применение полосового фильтра Баттерворта для удаления шумов.

- **Извлечение признаков**:
  - `moving_window`: Применение скользящего окна с перекрытием и усреднение данных.
  - `apply_window_and_fft`: Применение скользящего окна и вычисление преобразования Фурье для извлечения частотных признаков.
  - `apply_windowed_wavelet_transform`: Применение оконного вейвлет-преобразования для извлечения временно-частотных признаков.
  - `column_wise_mean`: Усреднение значений по столбцам для каждой записи в данных для получения одномерных признаков, подходящих классическим методам машинного обучения.

- **Работа с моделями**:
  - `process_data`: Обработка данных и разделение на обучающую, валидационную и тестовую выборки с равномерным распределением по классам.
  - `normalize_channels`: Нормализация данных для всех каналов.
  - `optimize_model_lstm`: Оптимизация модели LSTM с использованием Optuna для поиска гиперпараметров, приводящих к наименьшим потерям на валидационной выборке.
  - `optimize_model_bilstm`: Оптимизация модели BiLSTM с помощью Optuna.
  - `optimize_model_svm`: Оптимизация модели SVM с использованием Optuna.
  - `optimize_model_sgd`: Оптимизация модели SGD с помощью Optuna.
  - `recreate_model`: Воссоздание модели с заданными гиперпараметрами.
  - `matrix_confusion`: Построение и визуализация матрицы ошибок.

## Установка

Для установки библиотеки, используйте команду:

```bash
pip install git+https://github.com/AskerNagoev/ClassMusEEG.git
```

Или скачайте репозиторий и установите локально:

```bash
git clone https://github.com/AskerNagoev/ClassMusEEG.git
cd ClassMusEEG
pip install -e .
```

## Пример использования

Пример того, как можно использовать библиотеку представлен в блокноте формата IPYNB.

## Предобученная модель

Можно загрузить уже обученную [модель](models/bi_lstm_model_10classes.h5) и [scaler](models/scaler_model_bilstm.pk), чтобы сделать предсказание на своих данных. Модель распознает 10 классов с тестовой точностью 89%. Для извлечения признаков необходимо брать фрагменты ЭЭГ с 5 по 45 секунду, при восприятии одного из 10 стимулов, подход извлечения - окно с FFT, где размер окна равен 3 секундам с перекрытием в 1.5 секунды, частоты - с 1 по 7.

В качестве стимулов используются MIDI файлы произведений с сайта http://www.jsbach.net.

| Стимул    | Название файла      | Название произведения                                                         |
|-----------|---------------------|-------------------------------------------------------------------------------|
| audio1    | fp-1all.mid         | Partita in A minor for Solo Flute - BWV 1013 (Allemande)                      |
| audio2    | fp-2cou.mid         | Partita in A minor for Solo Flute - BWV 1013 (Courante)                       |
| audio3    | fp-3sar.mid         | Partita in A minor for Solo Flute - BWV 1013 (Sarabande)                      |
| audio4    | fp-4bou.mid         | Partita in A minor for Solo Flute - BWV 1013 (Bourée Anglaise)                |
| audio5    | vp2-1all.mid        | Partita No. 2 in D minor - BWV 1004 (Allemande)                               |
| audio6    | vs1-4prs.mid        | Sonata No. 1 in G minor - BWV 1001 (Presto)                                   |
| audio7    | vp1-1al_v2.mid      | Partita No. 1 in B minor - BWV 1002 (Allemanda)                               |
| audio8    | vp2-4gig_v2.mid     | Partita No. 2 in D minor - BWV 1004 (Gigue)                                   |
| audio9    | vp3-2lou.mid        | Partita No. 3 in E major - BWV 1006 (Loure)                                   |
| audio10   | vp3-3gav_v2.mid     | Partita No. 3 in E major - BWV 1006 (Gavotte en Rondeau)


## Структура проекта

```
ClassMusEEG/
│
├── classmuseeg/                   # Основная папка с кодом
│ ├── init.py                      # Главный файл библиотеки
│ ├── data_preprocessing.py        # Загрузка и подготовка данных
│ ├── feature_extraction.py        # Извлечение признаков
│ ├── model_operations.py          # Работа с моделями
│
├── models/                        # Папка с моделями
│ ├── bi_Lstm_model_10classes.h5   # Модель BiLSTM для классификации с 10 классами
│ └── scaler_model_bilstm.pkl      # Модель масштабирования (нормализации)
│
├── setup.py                       # Файл для установки библиотеки
├── README.md                      # Документация
├── LICENSE                        # Лицензия
├── requirements.txt               # Список зависимостей
└── examples.ipynb                 # Пример использования библиотеки
```

## Зависимости

Для работы библиотеки необходимо установить зависимости с помощью:

```bash
pip install -r requirements.txt
```

## Лицензия

Проект под лицензией MIT. Подробнее см. файл [LICENSE](LICENSE).

## Источники

1. Di Liberto, Giovanni; Pelofi, Claire; Bianco, Roberta et al. (2021). Cortical encoding of melodic expectations in human temporal cortex (Dataset). Dryad. https://doi.org/10.5061/dryad.g1jwstqmh 
